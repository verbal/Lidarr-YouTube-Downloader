<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lidarr YouTube Downloader</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1384/1384060.png">
    <style>
        :root {
            --bg: #09090b;
            --surface: #18181b;
            --surface-hover: #27272a;
            --text: #fafafa;
            --text-dim: #a1a1aa;
            --primary: #10b981;
            --primary-hover: #059669;
            --danger: #ef4444;
            --border: #27272a;
            --radius: 12px;
        }
        body.light {
            --bg: #f4f4f5; --surface: #ffffff; --surface-hover: #f4f4f5; --text: #18181b; --text-dim: #71717a; --border: #e4e4e7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; transition: background 0.2s, border-color 0.2s; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        
        header {
            background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; padding: 1rem 0;
        }
        body.light header { background: rgba(255, 255, 255, 0.8); }
        
        .nav-container {
            max-width: 1400px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem; }
        .nav-links { display: flex; gap: 1.5rem; align-items: center; }
        .nav-links a { color: var(--text); text-decoration: none; font-weight: 500; transition: color 0.2s; }
        .nav-links a:hover { color: var(--primary); }
        .controls { display: flex; gap: 1rem; align-items: center; }
        .icon-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .icon-btn:hover { background: var(--surface-hover); border-color: var(--primary); }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; width: 100%; flex: 1; }
        .config-panel { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 2rem; }
        
        .controls-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .filter-group { display: flex; gap: 0.5rem; flex: 1; flex-wrap: wrap; min-width: 300px; }
        .search-box { position: relative; flex: 1; }
        .search-box input { width: 100%; padding: 0.75rem 1rem; border-radius: 30px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        
        select.filter-select {
            padding: 0.75rem 2rem 0.75rem 1rem;
            border-radius: 30px;
            border: 1px solid var(--border);
            background: var(--surface) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a1a1aa' d='M6 8.825L1.175 4 2.238 2.938 6 6.7 9.763 2.938 10.825 4z'/%3E%3C/svg%3E") no-repeat right 1rem center;
            color: var(--text);
            appearance: none;
            cursor: pointer;
            outline: none;
        }
        select.filter-select:focus { border-color: var(--primary); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; }
        .card { 
            background: var(--surface); border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); position: relative; display: flex; flex-direction: column; 
            animation: fadeIn 0.5s ease forwards; opacity: 0;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .card:hover { transform: translateY(-4px); transition: transform 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        .card-img-container { position: relative; padding-top: 100%; background: #222; }
        .card-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .card-content { padding: 1.25rem; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-artist { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem; }
        .card-actions { margin-top: auto; display: flex; gap: 0.75rem; }
        .btn { flex: 1; padding: 0.6rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .download-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; z-index: 10; backdrop-filter: blur(4px); }
        .download-overlay.active { display: flex; }
        
        footer { text-align: center; padding: 2rem; color: var(--text-dim); font-size: 0.9rem; border-top: 1px solid var(--border); margin-top: auto; }

        @media (max-width: 768px) {
            .nav-container { flex-direction: column; gap: 1rem; padding: 1rem; text-align: center; }
            .nav-links { width: 100%; justify-content: center; }
            .controls { width: 100%; justify-content: center; }
            .filter-group { width: 100%; flex-direction: column; }
            .search-box, .filter-select { width: 100%; }
            .grid { grid-template-columns: 1fr; }
            .card { max-width: 400px; margin: 0 auto; width: 100%; }
            .container { padding: 1rem; }
            .config-panel { text-align: center; }
            .controls-row { justify-content: center; flex-direction: column; gap: 1rem; }
            button.btn { width: 100%; }
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <div class="logo">üéµ Lidarr YouTube Downloader</div>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/scheduler">Scheduler</a>
            </div>
            <div class="controls">
                <button class="icon-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon" id="themeIcon"></i></button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="config-panel">
            <div class="controls-row">
                <h2 style="margin:0; width: 100%; text-align: center; margin-bottom: 1rem;">Library</h2>
                <div class="filter-group">
                    <div class="search-box"><input type="text" id="artistSearch" placeholder="Search artists or albums..."></div>
                    <select id="sortFilter" class="filter-select">
                        <option value="newest">üìÖ Newest First</option>
                        <option value="missing">üìâ Most Missing Tracks</option>
                        <option value="alpha">üî§ Alphabetical (A-Z)</option>
                    </select>
                </div>
            </div>
            <div class="controls-row">
                <button class="btn btn-secondary" onclick="testConnection()">Check Connection</button>
                <button class="btn btn-primary" onclick="loadAlbums()">Refresh Library</button>
            </div>
            <div id="connectionStatus" style="margin-top:1rem; display:none"></div>
        </div>
        <div class="grid" id="albumGrid"></div>
    </div>

    <footer>Made with love ‚ù§Ô∏è</footer>

    <script>
        let currentAlbumId = null;
        let pollingInterval = null;
        let allAlbums = [];

        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('theme') || 'dark';
            if(saved === 'light') {
                document.body.classList.add('light');
                document.getElementById('themeIcon').className = 'fa-solid fa-sun';
            }
            loadAlbums();
        });

        function toggleTheme() {
            document.body.classList.toggle('light');
            const isLight = document.body.classList.contains('light');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            document.getElementById('themeIcon').className = isLight ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        function applyFilters() {
            const term = document.getElementById('artistSearch').value.toLowerCase();
            const sortType = document.getElementById('sortFilter').value;
            
            let filtered = allAlbums.filter(album => 
                album.title.toLowerCase().includes(term) || 
                album.artist.artistName.toLowerCase().includes(term)
            );

            if (sortType === 'missing') {
                filtered.sort((a, b) => b.missingTrackCount - a.missingTrackCount);
            } else if (sortType === 'alpha') {
                filtered.sort((a, b) => a.title.localeCompare(b.title));
            } else { 
                filtered.sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate));
            }

            renderGrid(filtered);
        }

        document.getElementById('artistSearch').addEventListener('input', applyFilters);
        document.getElementById('sortFilter').addEventListener('change', applyFilters);

        function renderGrid(albums) {
            const grid = document.getElementById('albumGrid');
            grid.innerHTML = '';

            if(albums.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center">No albums match your criteria.</div>';
                return;
            }

            albums.forEach((album, index) => {
                const cover = album.images?.find(i => i.coverType === 'cover')?.remoteUrl || '';
                const year = album.releaseDate?.substring(0,4) || '';
                const div = document.createElement('div');
                div.className = 'card';
                div.style.animationDelay = `${index * 0.05}s`;
                div.innerHTML = `
                    <div class="card-img-container"><img src="${cover}" class="card-img"></div>
                    <div class="card-content">
                        <div class="card-title">${album.title}</div>
                        <div class="card-artist">${album.artist.artistName}</div>
                        <div style="font-size:0.8rem; color:var(--text-dim); margin-bottom:1rem">${year} ‚Ä¢ ${album.missingTrackCount} Missing</div>
                        <div class="card-actions">
                            <button class="btn btn-primary" onclick="startDownload(${album.id})">Download</button>
                        </div>
                    </div>
                    <div class="download-overlay" id="overlay-${album.id}">
                        <div style="margin-bottom:0.5rem; font-weight:bold;" id="status-${album.id}">Starting...</div>
                        <div style="font-size:0.9rem; color:#ccc" id="substatus-${album.id}">0%</div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        async function testConnection() {
            const el = document.getElementById('connectionStatus');
            el.style.display = 'block'; el.innerHTML = 'Testing...';
            const res = await fetch('/api/test-connection');
            const data = await res.json();
            el.innerHTML = data.status === 'success' 
                ? `<span style="color:var(--primary)">Connected to Lidarr ${data.lidarr_version}</span>` 
                : `<span style="color:var(--danger)">Error: ${data.error}</span>`;
        }

        async function loadAlbums() {
            const grid = document.getElementById('albumGrid');
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center">Loading...</div>';
            const res = await fetch('/api/missing-albums');
            allAlbums = await res.json();
            applyFilters();
        }

        async function startDownload(id) {
            document.getElementById(`overlay-${id}`).classList.add('active');
            await fetch(`/api/download/${id}`, { method: 'POST' });
            if(!pollingInterval) pollingInterval = setInterval(poll, 1000);
        }

        async function poll() {
            const res = await fetch('/api/download/status');
            const data = await res.json();
            if(!data.active) {
                clearInterval(pollingInterval); pollingInterval = null;
                document.querySelectorAll('.download-overlay').forEach(e => e.classList.remove('active'));
                loadAlbums();
                return;
            }
            const ov = document.getElementById(`overlay-${data.album_id}`);
            if(ov) {
                ov.classList.add('active');
                if(data.progress.percent) {
                    document.getElementById(`substatus-${data.album_id}`).innerText = `${data.progress.percent} (${data.progress.speed})`;
                    document.getElementById(`status-${data.album_id}`).innerText = "Downloading";
                } else if (data.progress.current) {
                    document.getElementById(`substatus-${data.album_id}`).innerText = `Track ${data.progress.current}/${data.progress.total}`;
                    document.getElementById(`status-${data.album_id}`).innerText = "Processing";
                }
            }
        }
    </script>
</body>
</html>
