<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lidarr YouTube Downloader</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        :root {
            --bg: #09090b;
            --bg-pattern: radial-gradient(circle at 20% 50%, rgba(16, 185, 129, 0.05) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(6, 214, 160, 0.05) 0%, transparent 50%);
            --surface: #18181b;
            --surface-glass: rgba(24, 24, 27, 0.7);
            --surface-hover: #27272a;
            --text: #fafafa;
            --text-dim: #a1a1aa;
            --primary: #10b981;
            --primary-hover: #059669;
            --danger: #ef4444;
            --border: #27272a;
            --border-glass: rgba(255, 255, 255, 0.1);
            --radius: 16px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.37);
            --glow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        body.light {
            --bg: #f4f4f5;
            --bg-pattern: radial-gradient(circle at 20% 50%, rgba(16, 185, 129, 0.03) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(6, 214, 160, 0.03) 0%, transparent 50%);
            --surface: #ffffff;
            --surface-glass: rgba(255, 255, 255, 0.7);
            --surface-hover: #f4f4f5;
            --text: #18181b;
            --text-dim: #71717a;
            --border: #e4e4e7;
            --border-glass: rgba(0, 0, 0, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --glow: 0 0 20px rgba(16, 185, 129, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            background-image: var(--bg-pattern);
            background-attachment: fixed;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        header {
            background: var(--surface-glass);
            backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
            border-bottom: 1px solid var(--border-glass);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 0;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }

        .logo {
            font-weight: 800;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            background: linear-gradient(135deg, var(--primary), #06d6a0, #0891b2);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 4s ease infinite;
            letter-spacing: -0.02em;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), #06d6a0);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-icon svg {
            width: 16px;
            height: 16px;
        }

        .nav-links {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-dim);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            padding: 0.5rem 0.9rem;
            border-radius: 10px;
            transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .nav-links a:hover {
            color: var(--text);
            background: var(--surface-hover);
        }

        .nav-links a.active {
            color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
        }

        .nav-badge {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 999px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            line-height: 1;
            animation: badgePop 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .nav-badge.active {
            display: inline-flex;
        }

        @keyframes badgePop {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 60%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), #06d6a0);
            border-radius: 1px;
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .nav-links a:hover::after,
        .nav-links a.active::after {
            transform: translateX(-50%) scaleX(1);
        }

        .controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .theme-toggle {
            background: var(--surface-glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-glass);
            color: var(--text);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        .theme-toggle:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
            box-shadow: var(--glow);
            transform: scale(1.08);
        }

        .theme-toggle:active {
            transform: scale(0.92);
        }

        .theme-toggle i {
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .theme-toggle.spin i {
            animation: themeSwitch 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes themeSwitch {
            0% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }
            50% {
                transform: rotate(180deg) scale(0);
                opacity: 0;
            }
            100% {
                transform: rotate(360deg) scale(1);
                opacity: 1;
            }
        }

        .icon-btn {
            background: var(--surface-glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-glass);
            color: var(--text);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .icon-btn:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
            box-shadow: var(--glow);
            transform: scale(1.08);
        }

        .progress-minimized-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #10b981, #06d6a0, #0891b2);
            background-size: 200% 200%;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
            z-index: 99;
            animation: gradient-shift 3s ease infinite;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .progress-minimized-btn.active {
            display: flex;
        }

        .progress-minimized-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.6);
        }

        .progress-minimized-btn:active {
            transform: scale(0.95);
        }

        .minimized-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 22px;
            height: 22px;
            padding: 0 5px;
            background: #ef4444;
            color: white;
            border-radius: 11px;
            font-size: 0.65rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            line-height: 1;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .minimized-progress-ring {
            position: absolute;
            top: -3px;
            left: -3px;
            width: 66px;
            height: 66px;
            pointer-events: none;
        }

        .minimized-progress-ring circle {
            fill: none;
            stroke-width: 3;
        }

        .minimized-progress-ring .ring-bg {
            stroke: rgba(255, 255, 255, 0.15);
        }

        .minimized-progress-ring .ring-fill {
            stroke: white;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
            flex: 1;
        }

        .config-panel {
            background: var(--surface-glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-glass);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex: 1;
            flex-wrap: wrap;
            min-width: 300px;
        }

        .view-mode-switcher {
            display: flex;
            gap: 0.5rem;
            background: var(--surface-glass);
            padding: 0.3rem;
            border-radius: 10px;
            border: 1px solid var(--border-glass);
        }

        .view-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-dim);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--glow);
        }

        .view-btn:hover:not(.active) {
            background: var(--surface-hover);
            color: var(--text);
        }

        .search-box {
            position: relative;
            flex: 1;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 30px;
            border: 1px solid var(--border-glass);
            background: var(--surface-glass);
            backdrop-filter: blur(10px);
            color: var(--text);
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
            transform: translateY(-1px);
        }

        select.filter-select {
            padding: 0.75rem 2rem 0.75rem 1rem;
            border-radius: 30px;
            border: 1px solid var(--border-glass);
            background: var(--surface-glass);
            backdrop-filter: blur(10px);
            color: var(--text);
            appearance: none;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2310b981' d='M6 8.825L1.175 4 2.238 2.938 6 6.7 9.763 2.938 10.825 4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }

        select.filter-select:focus {
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }

        .list-view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .table-view {
            overflow-x: auto;
        }

        .table-view table {
            min-width: 650px;
        }

        .table-desktop {
            display: table;
        }

        .table-mobile {
            display: none;
        }

        .card {
            background: var(--surface-glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border-glass);
            position: relative;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(16, 185, 129, 0.2), 0 0 0 1px rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.5);
        }

        .card-img-container {
            position: relative;
            padding-top: 100%;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            overflow: hidden;
        }

        .cover-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
        }

        .cover-placeholder svg {
            width: 40%;
            height: 40%;
            opacity: 0.3;
        }

        .list-item-placeholder,
        .table-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 8px;
        }

        .list-item-placeholder {
            width: 60px;
            height: 60px;
        }

        .table-placeholder {
            width: 50px;
            height: 50px;
        }

        .list-item-placeholder svg,
        .table-placeholder svg {
            width: 50%;
            height: 50%;
            opacity: 0.3;
        }

        .card-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .card:hover .card-img {
            transform: scale(1.1);
        }

        .card-content {
            padding: 1.25rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--surface-glass);
        }

        .card-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-artist {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .card-actions {
            margin-top: auto;
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            flex: 1;
            padding: 0.6rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #06d6a0, #0891b2);
            background-size: 200% 200%;
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            animation: gradient-shift 3s ease infinite;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.6);
            transform: translateY(-2px);
        }

        @keyframes gradient-shift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .btn-secondary {
            background: var(--surface-glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-glass);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .list-item {
            background: var(--surface-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: var(--radius);
            padding: 1rem;
            border: 1px solid var(--border-glass);
            display: flex;
            gap: 1rem;
            align-items: center;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            transform: translateX(4px);
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .list-item-img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .list-item-info {
            flex: 1;
        }

        .list-item-title {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .list-item-artist {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .list-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            overflow: hidden;
        }

        th {
            background: var(--surface);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--border-glass);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-glass);
        }

        tr:hover {
            background: var(--surface-hover);
        }

        .table-img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }

        .table-album-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 280px;
        }

        .table-artist, .table-year {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table-artist {
            max-width: 180px;
        }

        .table-year {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .th-sortable {
            cursor: pointer;
            user-select: none;
            transition: color 0.2s ease;
            position: relative;
        }

        .th-sortable:hover {
            color: var(--primary);
        }

        .th-sortable .sort-arrow {
            margin-left: 0.3rem;
            font-size: 0.65rem;
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }

        .th-sortable.sort-active .sort-arrow {
            opacity: 1;
            color: var(--primary);
        }

        .download-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(6, 214, 160, 0.9));
            backdrop-filter: blur(20px);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            z-index: 10;
            animation: fadeInOverlay 0.3s ease;
        }

        .download-overlay.active {
            display: flex;
        }

        @keyframes fadeInOverlay {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .card-progress-indicator {
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            padding: 0.75rem;
            border-top: 1px solid var(--border-glass);
            display: none;
            animation: slideInProgress 0.3s ease;
        }

        .card-progress-indicator.active {
            display: block;
        }

        @keyframes slideInProgress {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .mini-progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .mini-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #06d6a0);
            border-radius: 999px;
            transition: width 0.3s ease;
            animation: shimmer 2s ease-in-out infinite;
        }

        .mini-progress-text {
            font-size: 0.75rem;
            color: var(--text-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mini-progress-track {
            font-weight: 600;
            color: var(--primary);
        }

        footer {
            text-align: center;
            padding: 1.5rem 2rem;
            color: var(--text-dim);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-glass);
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            margin-top: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.6rem;
        }

        .footer-github {
            color: var(--text-dim);
            font-size: 1.3rem;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .footer-github:hover {
            color: var(--primary);
            transform: scale(1.15);
        }

        .progress-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 420px;
            max-width: calc(100vw - 4rem);
            background: rgba(24, 24, 27, 0.95);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            z-index: 100;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: none;
        }

        body.light .progress-container {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .progress-container.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 0.75rem;
        }

        .progress-cover {
            width: 52px;
            height: 52px;
            min-width: 52px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--border);
            display: none;
        }

        .progress-cover.active {
            display: block;
        }

        .progress-info {
            flex: 1;
            min-width: 0;
        }

        .progress-info h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-info p {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-close {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .progress-close:hover {
            background: var(--surface-hover);
            color: var(--text);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            transform: translateY(-1px);
        }

        .btn-danger:active {
            transform: scale(0.96);
        }

        .progress-track-info {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .track-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--primary);
        }

        .track-status {
            color: var(--text-dim);
            font-size: 0.8rem;
        }

        .progress-bar-container {
            margin-bottom: 0.75rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .progress-bar {
            height: 10px;
            background: var(--bg);
            border-radius: 999px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #06d6a0, #10b981);
            background-size: 200% 100%;
            border-radius: 999px;
            transition: width 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            animation: shimmer 2s ease-in-out infinite;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 1.5s ease-in-out infinite;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .stat-item i {
            font-size: 0.7rem;
            color: var(--primary);
        }

        .progress-queue {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-glass);
        }

        .queue-header {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .queue-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .queue-item-mini {
            background: var(--bg);
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .queue-item-position {
            width: 20px;
            height: 20px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .queue-item-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @keyframes slideUp {
            from {
                transform: translateY(120px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes shimmer {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .pulsing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        @media (max-width: 768px) {
            .nav-container {
                height: auto;
                flex-wrap: wrap;
                padding: 0.75rem 1rem;
                gap: 0.5rem;
            }

            .logo {
                font-size: 1rem;
            }

            .nav-links {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 0.15rem;
                order: 3;
            }

            .nav-links a {
                padding: 0.35rem 0.7rem;
                font-size: 0.8rem;
            }

            .filter-group {
                width: 100%;
                flex-direction: column;
            }

            .view-mode-switcher {
                width: 100%;
                justify-content: center;
            }

            .search-box,
            .filter-select {
                width: 100%;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .card {
                max-width: 400px;
                margin: 0 auto;
                width: 100%;
            }

            .container {
                padding: 1rem;
            }

            .config-panel {
                text-align: center;
            }

            .controls-row {
                justify-content: center;
                flex-direction: column;
                gap: 1rem;
            }

            button.btn {
                width: 100%;
            }

            .progress-container {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                width: auto;
                max-width: none;
            }

            .progress-minimized-btn {
                bottom: 1rem;
                right: 1rem;
                width: 56px;
                height: 56px;
                font-size: 1.3rem;
            }

            .minimized-progress-ring {
                width: 62px;
                height: 62px;
            }

            .table-view {
                margin: 0 -1rem;
                padding: 0 1rem;
                overflow-x: hidden;
            }

            .table-desktop {
                display: none !important;
            }

            .table-mobile {
                display: table !important;
                width: 100%;
                min-width: 0 !important;
                table-layout: fixed;
                font-size: 0.8rem;
            }

            .table-mobile th,
            .table-mobile td {
                padding: 0.5rem 0.4rem;
            }

            .table-mobile th:first-child,
            .table-mobile td:first-child {
                padding-left: 0.5rem;
            }

            .table-mobile th:last-child,
            .table-mobile td:last-child {
                width: 44px;
                text-align: center;
                padding-left: 0;
                padding-right: 0.3rem;
            }

            .table-mobile th:nth-child(2),
            .table-mobile td:nth-child(2) {
                width: 50px;
                text-align: center;
                padding-left: 0;
                padding-right: 0;
                font-size: 0.75rem;
            }

            .table-mobile .mob-cell {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .table-mobile .mob-cover {
                width: 32px;
                height: 32px;
                border-radius: 6px;
                object-fit: cover;
                flex-shrink: 0;
            }

            .table-mobile .mob-cover-ph {
                width: 32px;
                height: 32px;
                border-radius: 6px;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #1a1a2e, #16213e);
            }

            .table-mobile .mob-cover-ph svg {
                width: 50%;
                height: 50%;
                opacity: 0.3;
            }

            .table-mobile .mob-info {
                min-width: 0;
                flex: 1;
            }

            .table-mobile .mob-title {
                font-weight: 600;
                font-size: 0.8rem;
                line-height: 1.3;
                white-space: normal;
                word-break: break-word;
            }

            .table-mobile .mob-artist {
                font-size: 0.7rem;
                color: var(--text-dim);
                line-height: 1.2;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .table-mobile .mob-btn {
                width: 34px;
                height: 34px;
                padding: 0 !important;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                font-size: 0.85rem;
            }

        }

        .alert-banner {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            color: var(--danger);
            animation: slideDown 0.3s ease;
        }

        .alert-banner i {
            font-size: 1.2rem;
            margin-top: 0.2rem;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-added {
            background: #059669 !important;
            animation: none !important;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4) !important;
        }

        .btn-downloading {
            background: rgba(59, 130, 246, 0.15) !important;
            color: #3b82f6 !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
            pointer-events: none;
            cursor: default;
            box-shadow: none !important;
        }

        .btn-downloading::before {
            display: none !important;
        }

        .btn-adding {
            pointer-events: none;
            opacity: 0.7;
        }

        @keyframes rippleEffect {
            0% {
                transform: scale(0);
                opacity: 0.6;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        .btn-ripple::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            margin-top: -15px;
            margin-left: -15px;
            animation: rippleEffect 0.6s ease-out;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface-glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--glow);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), #06d6a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }
        }

        .skeleton-card {
            background: var(--surface-glass);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border-glass);
        }

        .skeleton-img {
            width: 100%;
            padding-top: 100%;
            background: linear-gradient(90deg, var(--surface) 25%, var(--surface-hover) 50%, var(--surface) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s ease-in-out infinite;
        }

        .skeleton-content {
            padding: 1.25rem;
        }

        .skeleton-line {
            height: 14px;
            border-radius: 7px;
            background: linear-gradient(90deg, var(--surface) 25%, var(--surface-hover) 50%, var(--surface) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s ease-in-out infinite;
            margin-bottom: 0.75rem;
        }

        .skeleton-line.short { width: 60%; }
        .skeleton-line.medium { width: 80%; }

        .skeleton-btn {
            height: 38px;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--surface) 25%, var(--surface-hover) 50%, var(--surface) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s ease-in-out infinite;
            margin-top: 1rem;
        }

        @keyframes skeletonShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .failed-overlay {
            position: fixed;
            inset: 0;
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .failed-overlay.active {
            display: flex;
        }

        .failed-overlay-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .failed-overlay-content {
            position: relative;
            background: var(--surface);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius);
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .failed-overlay-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-glass);
            position: sticky;
            top: 0;
            background: var(--surface);
            z-index: 1;
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .failed-overlay-header img {
            width: 52px;
            height: 52px;
            border-radius: 8px;
            object-fit: cover;
        }

        .failed-overlay-header .fo-info {
            flex: 1;
            min-width: 0;
        }

        .failed-overlay-header .fo-info h3 {
            font-size: 1.1rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .failed-overlay-header .fo-info p {
            color: var(--text-dim);
            font-size: 0.85rem;
            margin-top: 0.15rem;
        }

        .failed-overlay-close {
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 1.3rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .failed-overlay-close:hover {
            background: var(--surface-hover);
            color: var(--text);
        }

        .failed-overlay-body {
            padding: 1.5rem;
        }

        .failed-overlay-subtitle {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .failed-track-item {
            background: var(--bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .failed-track-item.resolved {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.05);
        }

        .failed-track-header {
            margin-bottom: 0.75rem;
        }

        .failed-track-title {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .failed-track-reason {
            font-size: 0.8rem;
            color: #ef4444;
            margin-top: 0.25rem;
            padding-left: 1.5rem;
        }

        .failed-track-success {
            color: var(--primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .failed-track-inputs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .failed-track-inputs input {
            flex: 1;
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--border-glass);
            background: var(--surface-glass);
            color: var(--text);
            font-size: 0.85rem;
            outline: none;
            transition: all 0.2s;
        }

        .failed-track-inputs input:focus {
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .ft-btn {
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .ft-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .ft-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .failed-track-separator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0.5rem 0;
            color: var(--text-dim);
            font-size: 0.8rem;
        }

        .failed-track-separator::before,
        .failed-track-separator::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .ft-search-results {
            display: none;
            margin-top: 0.75rem;
            max-height: 260px;
            overflow-y: auto;
            border-radius: 8px;
        }

        .ft-search-results.active {
            display: block;
        }

        .ft-result-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem;
            border-radius: 8px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .ft-result-item:hover {
            background: var(--surface-hover);
            border-color: var(--border-glass);
        }

        .ft-result-item img {
            width: 48px;
            height: 36px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .ft-result-info {
            flex: 1;
            min-width: 0;
        }

        .ft-result-title {
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ft-result-meta {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .ft-result-preview {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid rgba(239, 68, 68, 0.4);
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .ft-result-preview:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: scale(1.1);
        }

        .ft-result-select {
            padding: 0.35rem 0.65rem;
            border-radius: 6px;
            border: 1px solid var(--primary);
            background: transparent;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .ft-result-select:hover {
            background: var(--primary);
            color: white;
        }

        .ft-video-preview {
            margin-top: 0.75rem;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        .ft-video-preview iframe {
            width: 100%;
            aspect-ratio: 16 / 9;
            border: none;
            display: block;
        }

        .ft-preview-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            z-index: 2;
            transition: all 0.2s;
        }

        .ft-preview-close:hover {
            background: #ef4444;
            transform: scale(1.1);
        }

        .failed-tracks-btn {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            height: 44px;
            padding: 0 1.2rem;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            background-size: 200% 200%;
            border: none;
            border-radius: 22px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.35);
            z-index: 99;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            animation: gradient-shift 3s ease infinite;
        }

        .failed-tracks-btn.active {
            display: inline-flex;
        }

        .failed-tracks-btn:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 12px 32px rgba(239, 68, 68, 0.5);
        }

        .failed-tracks-btn:active {
            transform: translateX(-50%) scale(0.97);
        }

        .ft-loading {
            text-align: center;
            padding: 0.75rem;
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .failed-overlay {
                padding: 1rem;
            }

            .failed-overlay-content {
                max-height: 90vh;
            }

            .failed-overlay-header {
                padding: 1rem;
            }

            .failed-overlay-body {
                padding: 1rem;
            }

            .failed-track-inputs {
                flex-direction: column;
            }

            .failed-track-inputs input {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="nav-container">
            <a href="/" style="text-decoration: none;">
                <div class="logo">
                    <div class="logo-icon">
                        <svg viewBox="0 0 32 32" fill="white"><rect x="4" y="18" width="4" height="8" rx="1"/><rect x="10" y="12" width="4" height="14" rx="1"/><rect x="18" y="6" width="4" height="20" rx="1"/><rect x="24" y="14" width="4" height="12" rx="1"/></svg>
                    </div>
                    LYD
                </div>
            </a>
            <div class="nav-links">
                <a href="/" class="active"><i class="fas fa-home"></i> Home</a>
                <a href="/downloads"><i class="fas fa-download"></i> Downloads <span class="nav-badge" id="queueBadge">0</span></a>
                <a href="/logs"><i class="fas fa-list"></i> Logs</a>
                <a href="/settings"><i class="fas fa-cog"></i> Settings</a>
            </div>
            <div class="controls">
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                    <i class="fa-solid fa-moon" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="alert-banner" id="pathConflictBanner" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>Configuration Warning:</strong> LIDARR_PATH matches DOWNLOAD_PATH.
                <p style="margin: 0.25rem 0 0; font-size: 0.9rem; opacity: 0.9;">
                    This configuration disabled auto-cleanup to prevent data loss. Please update your settings.
                </p>
            </div>
        </div>

        <div class="stats-bar" id="statsBar">
            <div class="stat-card">
                <div class="stat-icon"><i class="fa-solid fa-compact-disc"></i></div>
                <div class="stat-value" id="statTotal">-</div>
                <div class="stat-label">Total Albums</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fa-solid fa-music"></i></div>
                <div class="stat-value" id="statMissing">-</div>
                <div class="stat-label">Missing Tracks</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fa-solid fa-list-ol"></i></div>
                <div class="stat-value" id="statQueue">-</div>
                <div class="stat-label">In Queue</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fa-solid fa-circle-check"></i></div>
                <div class="stat-value" id="statToday">-</div>
                <div class="stat-label">Downloaded Today</div>
            </div>
        </div>

        <div class="config-panel">
            <div class="controls-row">
                <h2 style="margin:0; width: 100%; text-align: center; margin-bottom: 1rem;">Library</h2>
                <div class="filter-group">
                    <div class="search-box"><input type="text" id="artistSearch"
                            placeholder="Search artists or albums..."></div>
                    <select id="sortFilter" class="filter-select">
                        <option value="newest"> Newest First</option>
                        <option value="missing"> Most Missing Tracks</option>
                        <option value="alpha"> Alphabetical (A-Z)</option>
                    </select>
                    <div class="view-mode-switcher">
                        <button class="view-btn active" onclick="setViewMode('cards')" id="viewCards">
                            <i class="fa-solid fa-grip"></i> Cards
                        </button>
                        <button class="view-btn" onclick="setViewMode('list')" id="viewList">
                            <i class="fa-solid fa-list"></i> List
                        </button>
                        <button class="view-btn" onclick="setViewMode('table')" id="viewTable">
                            <i class="fa-solid fa-table"></i> Table
                        </button>
                    </div>
                </div>
            </div>
            <div class="controls-row">
                <button class="btn btn-secondary" onclick="testConnection()">Check Connection</button>
                <button class="btn btn-primary" onclick="loadAlbums()">Refresh Library</button>
                <button class="btn btn-primary" id="downloadAllBtn" onclick="downloadAllMissing(event)" style="background: linear-gradient(135deg, #0891b2, #06d6a0); animation: none;">
                    <i class="fa-solid fa-download"></i> Download All Missing
                </button>
            </div>
            <div id="connectionStatus" style="margin-top:1rem; display:none"></div>
        </div>
        <div id="albumContainer"></div>
    </div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-header">
            <img id="progressCover" class="progress-cover" src="" alt="">
            <div class="progress-info">
                <h3 id="progressAlbumTitle">Downloading Album</h3>
                <p id="progressArtistName">Artist Name</p>
            </div>
            <button class="progress-close" onclick="hideProgress()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="progress-track-info">
            <div class="track-title">
                <span class="pulsing-dot"></span>
                <span id="currentTrackTitle">Preparing download...</span>
            </div>
            <div class="track-status" id="trackStatus">Initializing...</div>
        </div>

        <div class="progress-bar-container">
            <div class="progress-label">
                <span>Overall Progress</span>
                <span id="overallPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <div class="progress-stats">
            <div class="stat-item">
                <i class="fa-solid fa-music"></i>
                <span id="trackProgress">Track 0/0</span>
            </div>
            <div class="stat-item">
                <i class="fa-solid fa-gauge-high"></i>
                <span id="downloadSpeed">--</span>
            </div>
        </div>

        <div class="progress-queue" id="progressQueue" style="display: none;">
            <div class="queue-header">
                <i class="fa-solid fa-list-ol"></i>
                <span>Queue (<span id="queueCount">0</span>)</span>
            </div>
            <div class="queue-list" id="queueList"></div>
        </div>

        <button class="btn-danger" onclick="stopDownload()">
            <i class="fa-solid fa-stop"></i> Stop Download
        </button>
    </div>

    <button class="progress-minimized-btn" id="progressMinimizedBtn" onclick="restoreProgress()">
        <svg class="minimized-progress-ring" viewBox="0 0 66 66">
            <circle class="ring-bg" cx="33" cy="33" r="30"></circle>
            <circle class="ring-fill" id="minimizedRing" cx="33" cy="33" r="30" stroke-dasharray="188.5" stroke-dashoffset="188.5"></circle>
        </svg>
        <i class="fa-solid fa-download"></i>
        <span class="minimized-badge" id="minimizedBadge">0/0</span>
    </button>

    <div class="failed-overlay" id="failedOverlay">
        <div class="failed-overlay-backdrop" onclick="closeFailedOverlay()"></div>
        <div class="failed-overlay-content">
            <div class="failed-overlay-header">
                <img id="failedAlbumCover" src="" alt="" style="display:none;">
                <div class="fo-info">
                    <h3 id="failedAlbumTitle">Album Title</h3>
                    <p id="failedArtistName">Artist Name</p>
                </div>
                <button class="failed-overlay-close" onclick="closeFailedOverlay()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="failed-overlay-body">
                <div class="failed-overlay-subtitle">
                    <i class="fa-solid fa-triangle-exclamation" style="color: #f59e0b;"></i>
                    <span id="failedSubtitle">Some tracks failed to download.</span>
                </div>
                <div id="failedTracksList"></div>
            </div>
        </div>
    </div>

    <button class="failed-tracks-btn" id="failedTracksBtn" onclick="reopenFailedOverlay()">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span id="failedTracksBtnText">0 Failed</span>
    </button>

    <footer>
        <div>Made with love   {{ APP_VERSION }}</div>
        <a href="https://github.com/Angrido/Lidarr-YouTube-Downloader" target="_blank" rel="noopener noreferrer" class="footer-github"><i class="fa-brands fa-github"></i></a>
    </footer>

    <script>
        let currentAlbumId = null;
        let pollingInterval = null;
        let allAlbums = [];
        let currentViewMode = 'cards';
        let isProgressMinimized = true;
        const ALBUMS_PER_PAGE = 50;
        let displayedCount = 0;
        let currentFiltered = [];
        let queuedAlbumIds = new Set();
        let wasDownloadActive = false;
        let failedTracksData = [];

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function sanitizeUrl(url) {
            if (!url) return '';
            try {
                const u = new URL(url);
                if (u.protocol === 'https:' || u.protocol === 'http:') return u.href;
            } catch (_) {}
            return '';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('theme') || 'dark';
            if (saved === 'light') {
                document.body.classList.add('light');
                document.getElementById('themeIcon').className = 'fa-solid fa-sun';
            }

            const savedView = localStorage.getItem('viewMode') || 'cards';
            setViewMode(savedView);

            loadAlbums();
            startGlobalPolling();
        });

        function toggleTheme() {
            const toggle = document.getElementById('themeToggle');
            toggle.classList.add('spin');
            setTimeout(() => {
                document.body.classList.toggle('light');
                const isLight = document.body.classList.contains('light');
                localStorage.setItem('theme', isLight ? 'light' : 'dark');
                document.getElementById('themeIcon').className = isLight ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            }, 250);
            setTimeout(() => toggle.classList.remove('spin'), 500);
        }

        function setViewMode(mode) {
            currentViewMode = mode;
            localStorage.setItem('viewMode', mode);

            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('view' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');

            applyFilters();
        }

        function getEmptyMessage() {
            if (allAlbums.length === 0) {
                return '<div style="padding:2.5rem 1rem;"><div style="font-size:2.5rem;margin-bottom:0.75rem;"></div><div style="font-size:1.15rem;font-weight:600;margin-bottom:0.5rem;">Your library is complete!</div><div style="color:var(--text-dim);font-size:0.9rem;">All albums are downloaded and ready to listen. Sit back and enjoy the music! </div></div>';
            }
            return '<div style="padding:2rem 1rem;"><div style="font-size:2rem;margin-bottom:0.5rem;"></div><div style="color:var(--text-dim);font-size:0.9rem;">No albums match your search. Try different keywords! </div></div>';
        }

        function applyFilters() {
            const term = document.getElementById('artistSearch').value.toLowerCase();
            const sortType = document.getElementById('sortFilter').value;

            currentFiltered = allAlbums.filter(album =>
                album.title.toLowerCase().includes(term) ||
                album.artist.artistName.toLowerCase().includes(term)
            );

            if (sortType === 'missing') {
                currentFiltered.sort((a, b) => b.missingTrackCount - a.missingTrackCount);
            } else if (sortType === 'alpha') {
                currentFiltered.sort((a, b) => a.title.localeCompare(b.title));
            } else {
                currentFiltered.sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate));
            }

            displayedCount = Math.min(ALBUMS_PER_PAGE, currentFiltered.length);

            if (currentViewMode === 'cards') renderCards();
            else if (currentViewMode === 'list') renderList();
            else if (currentViewMode === 'table') renderTable();

            updateLoadMoreBtn();
            updateQueueButtons();
        }

        function loadMore() {
            const prevCount = displayedCount;
            displayedCount = Math.min(displayedCount + ALBUMS_PER_PAGE, currentFiltered.length);
            const slice = currentFiltered.slice(prevCount, displayedCount);

            if (currentViewMode === 'cards') appendCards(slice);
            else if (currentViewMode === 'list') appendList(slice);
            else if (currentViewMode === 'table') appendTableRows(slice);

            updateLoadMoreBtn();
        }

        function updateLoadMoreBtn() {
            let loadMoreBtn = document.getElementById('loadMoreBtn');
            if (displayedCount < currentFiltered.length) {
                if (!loadMoreBtn) {
                    loadMoreBtn = document.createElement('div');
                    loadMoreBtn.id = 'loadMoreBtn';
                    loadMoreBtn.style.cssText = 'text-align:center; margin-top:2rem;';
                    document.getElementById('albumContainer').after(loadMoreBtn);
                }
                const remaining = currentFiltered.length - displayedCount;
                loadMoreBtn.innerHTML = `<button class="btn btn-secondary" onclick="loadMore()" style="padding:0.8rem 2rem; min-width:200px;">
                    <i class="fa-solid fa-angles-down"></i> Load More (${remaining} remaining)
                </button>
                <div style="margin-top:0.5rem; font-size:0.8rem; color:var(--text-dim);">Showing ${displayedCount} of ${currentFiltered.length}</div>`;
            } else {
                if (loadMoreBtn) loadMoreBtn.remove();
            }
        }

        let searchDebounceTimer = null;
        document.getElementById('artistSearch').addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(applyFilters, 300);
        });
        document.getElementById('sortFilter').addEventListener('change', applyFilters);

        const placeholderSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>`;

        function createCardElement(album, index) {
            const cover = album.images?.find(i => i.coverType === 'cover')?.remoteUrl || '';
            const year = album.releaseDate?.substring(0, 4) || '';
            const div = document.createElement('div');
            div.className = 'card';
            div.style.animationDelay = `${(index % ALBUMS_PER_PAGE) * 0.05}s`;
            const coverHtml = cover
                ? `<div class="card-img-container"><img src="${cover}" class="card-img"></div>`
                : `<div class="card-img-container"><div class="cover-placeholder">${placeholderSvg}</div></div>`;
            div.innerHTML = `
                ${coverHtml}
                <div class="card-content">
                    <div class="card-title">${escapeHtml(album.title)}</div>
                    <div class="card-artist">${escapeHtml(album.artist.artistName)}</div>
                    <div style="font-size:0.8rem; color:var(--text-dim); margin-bottom:1rem">${escapeHtml(year)}  ${album.missingTrackCount} Missing</div>
                    <div class="card-actions">
                        <button class="btn btn-primary" data-album-id="${album.id}" onclick="addToQueue(${album.id}, event)">Add to Queue</button>
                    </div>
                </div>
                <div class="card-progress-indicator" id="card-progress-${album.id}">
                    <div class="mini-progress-bar">
                        <div class="mini-progress-fill" id="mini-fill-${album.id}" style="width: 0%"></div>
                    </div>
                    <div class="mini-progress-text">
                        <span class="mini-progress-track" id="mini-track-${album.id}">Track 0/0</span>
                        <span id="mini-percent-${album.id}">0%</span>
                    </div>
                </div>
            `;
            return div;
        }

        function renderCards(albums) {
            const container = document.getElementById('albumContainer');
            container.className = 'grid';
            container.innerHTML = '';

            if (currentFiltered.length === 0) {
                container.innerHTML = `<div style="grid-column:1/-1;text-align:center">${getEmptyMessage()}</div>`;
                return;
            }

            const page = currentFiltered.slice(0, displayedCount);
            page.forEach((album, index) => {
                container.appendChild(createCardElement(album, index));
            });
        }

        function appendCards(albums) {
            const container = document.getElementById('albumContainer');
            const startIndex = displayedCount - albums.length;
            albums.forEach((album, i) => {
                container.appendChild(createCardElement(album, startIndex + i));
            });
        }

        function renderList(albums) {
            const container = document.getElementById('albumContainer');
            container.className = 'list-view';
            container.innerHTML = '';

            if (currentFiltered.length === 0) {
                container.innerHTML = `<div style="text-align:center">${getEmptyMessage()}</div>`;
                return;
            }

            const page = currentFiltered.slice(0, displayedCount);
            page.forEach(album => {
                container.appendChild(createListElement(album));
            });
        }

        function createListElement(album) {
            const cover = album.images?.find(i => i.coverType === 'cover')?.remoteUrl || '';
            const year = album.releaseDate?.substring(0, 4) || '';
            const div = document.createElement('div');
            div.className = 'list-item';
            const listCoverHtml = cover
                ? `<img src="${cover}" class="list-item-img">`
                : `<div class="list-item-placeholder">${placeholderSvg}</div>`;
            div.innerHTML = `
                ${listCoverHtml}
                <div class="list-item-info">
                    <div class="list-item-title">${escapeHtml(album.title)}</div>
                    <div class="list-item-artist">${escapeHtml(album.artist.artistName)}  ${escapeHtml(year)}  ${album.missingTrackCount} Missing</div>
                </div>
                <div class="list-item-actions">
                    <button class="btn btn-primary" data-album-id="${album.id}" onclick="addToQueue(${album.id}, event)">Add to Queue</button>
                </div>
            `;
            return div;
        }

        function appendList(albums) {
            const container = document.getElementById('albumContainer');
            albums.forEach(album => {
                container.appendChild(createListElement(album));
            });
        }

        let tableSortState = { column: null, direction: 'asc' };

        function getTableSortArrow(col) {
            if (tableSortState.column !== col) return '<span class="sort-arrow"></span>';
            return tableSortState.direction === 'asc'
                ? '<span class="sort-arrow"></span>'
                : '<span class="sort-arrow"></span>';
        }

        function renderTable(albums) {
            const container = document.getElementById('albumContainer');
            container.className = 'table-view';

            if (currentFiltered.length === 0) {
                container.innerHTML = `<div style="text-align:center">${getEmptyMessage()}</div>`;
                return;
            }

            const page = currentFiltered.slice(0, displayedCount);

            let desktopHtml = `<table class="table-desktop"><thead><tr>
                <th>Cover</th>
                <th>Album</th>
                <th class="th-sortable ${tableSortState.column === 'artist' ? 'sort-active' : ''}" onclick="sortTableBy('artist')">Artist ${getTableSortArrow('artist')}</th>
                <th class="th-sortable ${tableSortState.column === 'year' ? 'sort-active' : ''}" onclick="sortTableBy('year')">Year ${getTableSortArrow('year')}</th>
                <th class="th-sortable ${tableSortState.column === 'missing' ? 'sort-active' : ''}" onclick="sortTableBy('missing')">Missing ${getTableSortArrow('missing')}</th>
                <th>Action</th>
            </tr></thead><tbody>`;

            let mobileHtml = `<table class="table-mobile"><thead><tr>
                <th>Album</th><th>Missing</th><th></th>
            </tr></thead><tbody>`;

            page.forEach(album => {
                desktopHtml += createTableRowHtml(album);
                mobileHtml += createMobileRowHtml(album);
            });

            desktopHtml += '</tbody></table>';
            mobileHtml += '</tbody></table>';
            container.innerHTML = desktopHtml + mobileHtml;
        }

        function createTableRowHtml(album) {
            const cover = album.images?.find(i => i.coverType === 'cover')?.remoteUrl || '';
            const year = album.releaseDate?.substring(0, 4) || '';
            const tableCoverHtml = cover
                ? `<img src="${cover}" class="table-img">`
                : `<div class="table-placeholder">${placeholderSvg}</div>`;
            return `
                <tr>
                    <td>${tableCoverHtml}</td>
                    <td><div class="table-album-title">${escapeHtml(album.title)}</div></td>
                    <td><span class="table-artist">${escapeHtml(album.artist.artistName)}</span></td>
                    <td><span class="table-year">${escapeHtml(year)}</span></td>
                    <td>${album.missingTrackCount}</td>
                    <td><button class="btn btn-primary" data-album-id="${album.id}" onclick="addToQueue(${album.id}, event)">Add to Queue</button></td>
                </tr>
            `;
        }

        function sortTableBy(column) {
            if (tableSortState.column === column) {
                tableSortState.direction = tableSortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                tableSortState.column = column;
                tableSortState.direction = 'asc';
            }

            const dir = tableSortState.direction === 'asc' ? 1 : -1;
            if (column === 'artist') {
                currentFiltered.sort((a, b) => dir * a.artist.artistName.localeCompare(b.artist.artistName));
            } else if (column === 'year') {
                currentFiltered.sort((a, b) => dir * ((a.releaseDate || '').localeCompare(b.releaseDate || '')));
            } else if (column === 'missing') {
                currentFiltered.sort((a, b) => dir * (a.missingTrackCount - b.missingTrackCount));
            }

            displayedCount = Math.min(ALBUMS_PER_PAGE, currentFiltered.length);
            renderTable();
            updateLoadMoreBtn();
            updateQueueButtons();
        }

        function createMobileRowHtml(album) {
            const cover = album.images?.find(i => i.coverType === 'cover')?.remoteUrl || '';
            const year = album.releaseDate?.substring(0, 4) || '';
            const artistYear = year ? `${escapeHtml(album.artist.artistName)}  ${escapeHtml(year)}` : escapeHtml(album.artist.artistName);
            const coverHtml = cover
                ? `<img src="${cover}" class="mob-cover">`
                : `<div class="mob-cover-ph">${placeholderSvg}</div>`;
            return `
                <tr>
                    <td><div class="mob-cell">${coverHtml}<div class="mob-info"><div class="mob-title">${escapeHtml(album.title)}</div><div class="mob-artist">${artistYear}</div></div></div></td>
                    <td>${album.missingTrackCount}</td>
                    <td><button class="btn btn-primary mob-btn" data-album-id="${album.id}" onclick="addToQueue(${album.id}, event)" title="Add to Queue"><i class="fa-solid fa-download"></i></button></td>
                </tr>
            `;
        }

        function appendTableRows(albums) {
            const desktopTbody = document.querySelector('#albumContainer .table-desktop tbody');
            if (desktopTbody) {
                albums.forEach(album => {
                    desktopTbody.insertAdjacentHTML('beforeend', createTableRowHtml(album));
                });
            }
            const mobileTbody = document.querySelector('#albumContainer .table-mobile tbody');
            if (mobileTbody) {
                albums.forEach(album => {
                    mobileTbody.insertAdjacentHTML('beforeend', createMobileRowHtml(album));
                });
            }
        }

        async function testConnection() {
            const el = document.getElementById('connectionStatus');
            el.style.display = 'block';
            el.innerHTML = 'Testing...';
            const res = await fetch('/api/test-connection');
            const data = await res.json();
            el.innerHTML = data.status === 'success'
                ? `<span style="color:var(--primary)">Connected to Lidarr ${data.lidarr_version}</span>`
                : `<span style="color:var(--danger)">Error: ${data.error}</span>`;
        }

        function showSkeletonLoading() {
            const container = document.getElementById('albumContainer');
            container.className = 'grid';
            let skeletons = '';
            for (let i = 0; i < 8; i++) {
                skeletons += `
                    <div class="skeleton-card" style="animation-delay: ${i * 0.1}s">
                        <div class="skeleton-img"></div>
                        <div class="skeleton-content">
                            <div class="skeleton-line medium"></div>
                            <div class="skeleton-line short"></div>
                            <div class="skeleton-line short" style="width:40%"></div>
                            <div class="skeleton-btn"></div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = skeletons;
        }

        async function loadAlbums() {
            showSkeletonLoading();
            const res = await fetch('/api/missing-albums');
            allAlbums = await res.json();
            applyFilters();
            updateStats();
        }

        async function updateStats() {
            const totalAlbums = allAlbums.length;
            const totalMissing = allAlbums.reduce((sum, a) => sum + (a.missingTrackCount || 0), 0);
            document.getElementById('statTotal').textContent = totalAlbums;
            document.getElementById('statMissing').textContent = totalMissing;
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                document.getElementById('statQueue').textContent = stats.in_queue;
                document.getElementById('statToday').textContent = stats.downloaded_today;
            } catch (e) {}
        }

        async function addToQueue(id, event) {
            const btn = event ? event.currentTarget : null;
            const isMobBtn = btn && btn.classList.contains('mob-btn');
            if (btn) {
                btn.classList.add('btn-adding', 'btn-ripple');
                btn.innerHTML = isMobBtn ? '<i class="fa-solid fa-spinner fa-spin"></i>' : '<i class="fa-solid fa-spinner fa-spin"></i> Adding...';
            }
            try {
                await fetch('/api/download/' + id, { method: 'POST' });
                if (btn) {
                    btn.classList.remove('btn-adding', 'btn-ripple');
                    btn.classList.add('btn-added');
                    btn.innerHTML = isMobBtn ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-solid fa-check"></i> Added ';
                    setTimeout(() => {
                        btn.classList.remove('btn-added');
                        if (!btn.classList.contains('btn-downloading')) {
                            if (btn.classList.contains('mob-btn')) {
                                btn.innerHTML = '<i class="fa-solid fa-download"></i>';
                            } else {
                                btn.innerHTML = 'Add to Queue';
                            }
                            btn.style.pointerEvents = '';
                        }
                    }, 2500);
                }
            } catch (e) {
                if (btn) {
                    btn.classList.remove('btn-adding', 'btn-ripple');
                    btn.innerHTML = isMobBtn ? '<i class="fa-solid fa-xmark"></i>' : '<i class="fa-solid fa-xmark"></i> Error';
                    btn.style.background = 'var(--danger)';
                    setTimeout(() => {
                        btn.style.background = '';
                        if (!btn.classList.contains('btn-downloading')) {
                            if (btn.classList.contains('mob-btn')) {
                                btn.innerHTML = '<i class="fa-solid fa-download"></i>';
                            } else {
                                btn.innerHTML = 'Add to Queue';
                            }
                            btn.style.pointerEvents = '';
                        }
                    }, 2000);
                }
            }
        }

        async function downloadAllMissing(event) {
            const btn = event ? event.currentTarget : document.getElementById('downloadAllBtn');
            const term = document.getElementById('artistSearch').value.toLowerCase();
            const filtered = allAlbums.filter(album =>
                album.title.toLowerCase().includes(term) ||
                album.artist.artistName.toLowerCase().includes(term)
            );
            if (filtered.length === 0) return;
            if (!confirm(`Add ${filtered.length} albums to download queue?`)) return;

            btn.classList.add('btn-adding');
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Adding 0/${filtered.length}...`;

            let added = 0;
            for (const album of filtered) {
                try {
                    await fetch('/api/download/' + album.id, { method: 'POST' });
                    added++;
                    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Adding ${added}/${filtered.length}...`;
                } catch (e) {}
            }

            btn.classList.remove('btn-adding');
            btn.classList.add('btn-added');
            btn.innerHTML = `<i class="fa-solid fa-check"></i> ${added} Added `;
            setTimeout(() => {
                btn.classList.remove('btn-added');
                btn.innerHTML = '<i class="fa-solid fa-download"></i> Download All Missing';
                btn.style.pointerEvents = '';
            }, 3000);
        }

        let statsCounter = 0;
        let eventSource = null;

        function startGlobalPolling() {
            connectSSE();
            setInterval(() => {
                statsCounter++;
                if (statsCounter % 10 === 0) updateStats();
            }, 1000);
        }

        function connectSSE() {
            if (eventSource) eventSource.close();
            eventSource = new EventSource('/api/download/stream');
            eventSource.onmessage = (event) => {
                try {
                    const payload = JSON.parse(event.data);
                    handleProgressUpdate(payload.status, payload.queue);
                } catch (e) {}
            };
            eventSource.onerror = () => {
                eventSource.close();
                setTimeout(connectSSE, 3000);
            };
        }

        function handleProgressUpdate(data, queue) {
            if (!data.active) {
                /* If there are still items in the queue, we're between albums 
                   keep the UI stable to prevent flicker */
                if (queue && queue.length > 0) {
                    queuedAlbumIds = new Set(queue.map(q => q.id));
                    updateQueueButtons();
                    return;
                }
                if (wasDownloadActive) {
                    wasDownloadActive = false;
                    checkFailedTracks();
                }
                isProgressMinimized = true;
                document.getElementById('progressContainer').classList.remove('active');
                document.getElementById('progressMinimizedBtn').classList.remove('active');
                document.getElementById('progressCover').classList.remove('active');
                document.querySelectorAll('.card-progress-indicator').forEach(e => e.classList.remove('active'));
                const badge = document.getElementById('queueBadge');
                badge.classList.remove('active');
                /* Reset minimized badge & ring */
                document.getElementById('minimizedBadge').textContent = '0/0';
                document.getElementById('minimizedRing').style.strokeDashoffset = 188.5;
                queuedAlbumIds = new Set();
                updateQueueButtons();
                return;
            }

            wasDownloadActive = true;
            /* Hide failed-tracks reopen button during a new download */
            document.getElementById('failedTracksBtn').classList.remove('active');
            document.getElementById('failedOverlay').classList.remove('active');

            if (!isProgressMinimized) {
                document.getElementById('progressContainer').classList.add('active');
                document.getElementById('progressMinimizedBtn').classList.remove('active');
            } else {
                document.getElementById('progressMinimizedBtn').classList.add('active');
                document.getElementById('progressContainer').classList.remove('active');
            }

            if (data.album_title) document.getElementById('progressAlbumTitle').textContent = data.album_title;
            if (data.artist_name) document.getElementById('progressArtistName').textContent = data.artist_name;
            if (data.current_track_title) document.getElementById('currentTrackTitle').textContent = data.current_track_title;

            const coverEl = document.getElementById('progressCover');
            const safeCoverUrl = sanitizeUrl(data.cover_url);
            if (safeCoverUrl) {
                coverEl.src = safeCoverUrl;
                coverEl.classList.add('active');
            } else {
                coverEl.classList.remove('active');
            }

            if (data.progress && data.progress.current && data.progress.total) {
                const currentTrack = data.progress.current;
                const totalTracks = data.progress.total;
                document.getElementById('trackProgress').textContent = `Track ${currentTrack}/${totalTracks}`;

                const overallPercent = data.progress.overall_percent || Math.round((currentTrack / totalTracks) * 100);
                document.getElementById('overallPercent').textContent = `${overallPercent}%`;
                document.getElementById('progressFill').style.width = `${overallPercent}%`;

                /* Update minimized button badge & ring */
                document.getElementById('minimizedBadge').textContent = `${currentTrack}/${totalTracks}`;
                const circumference = 2 * Math.PI * 30; /* r=30, ~188.5 */
                const offset = circumference - (circumference * overallPercent / 100);
                document.getElementById('minimizedRing').style.strokeDashoffset = offset;

                const cardProgress = document.getElementById(`card-progress-${data.album_id}`);
                if (cardProgress) {
                    cardProgress.classList.add('active');
                    document.getElementById(`mini-fill-${data.album_id}`).style.width = `${overallPercent}%`;
                    document.getElementById(`mini-track-${data.album_id}`).textContent = `Track ${currentTrack}/${totalTracks}`;
                    document.getElementById(`mini-percent-${data.album_id}`).textContent = `${overallPercent}%`;
                }
            }

            if (data.progress && data.progress.percent) {
                document.getElementById('trackStatus').textContent = `Downloading: ${data.progress.percent}`;
                document.getElementById('downloadSpeed').textContent = data.progress.speed || '--';
            } else {
                document.getElementById('trackStatus').textContent = 'Processing track...';
                document.getElementById('downloadSpeed').textContent = '--';
            }

            queuedAlbumIds = new Set(queue.map(q => q.id));
            if (data.active && data.album_id) queuedAlbumIds.add(data.album_id);

            const totalInQueue = queue.length + (data.active ? 1 : 0);
            const badge = document.getElementById('queueBadge');
            if (totalInQueue > 0) {
                badge.textContent = totalInQueue;
                badge.classList.add('active');
            } else {
                badge.classList.remove('active');
            }

            if (queue.length > 0) {
                document.getElementById('progressQueue').style.display = 'block';
                document.getElementById('queueCount').textContent = queue.length;
                document.getElementById('queueList').innerHTML = queue.slice(0, 3).map((item, index) => `
                    <div class="queue-item-mini">
                        <div class="queue-item-position">${index + 1}</div>
                        <div class="queue-item-text">${escapeHtml(item.title)} - ${escapeHtml(item.artist)}</div>
                    </div>
                `).join('');
            } else {
                document.getElementById('progressQueue').style.display = 'none';
            }

            updateQueueButtons();
        }

        function updateQueueButtons() {
            document.querySelectorAll('[data-album-id]').forEach(btn => {
                const albumId = parseInt(btn.dataset.albumId);
                if (queuedAlbumIds.has(albumId)) {
                    if (!btn.classList.contains('btn-downloading')) {
                        btn.classList.add('btn-downloading');
                        if (btn.classList.contains('mob-btn')) {
                            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                        } else {
                            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Downloading';
                        }
                    }
                } else {
                    if (btn.classList.contains('btn-downloading')) {
                        btn.classList.remove('btn-downloading');
                        if (btn.classList.contains('mob-btn')) {
                            btn.innerHTML = '<i class="fa-solid fa-download"></i>';
                        } else {
                            btn.innerHTML = 'Add to Queue';
                        }
                    }
                }
            });
        }

        function hideProgress() {
            isProgressMinimized = true;
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('progressMinimizedBtn').classList.add('active');
        }

        function restoreProgress() {
            isProgressMinimized = false;
            document.getElementById('progressContainer').classList.add('active');
            document.getElementById('progressMinimizedBtn').classList.remove('active');
        }

        async function stopDownload() {
            if (confirm('Are you sure you want to stop the current download?')) {
                await fetch('/api/download/stop', { method: 'POST' });
                hideProgress();
            }
        }

        async function checkFailedTracks() {
            try {
                const res = await fetch('/api/download/failed');
                const data = await res.json();
                if (data.failed_tracks && data.failed_tracks.length > 0) {
                    showFailedTracksOverlay(data);
                }
            } catch (e) {
                console.error('Failed to check failed tracks:', e);
            }
        }

        function showFailedTracksOverlay(data) {
            failedTracksData = data.failed_tracks;
            document.getElementById('failedAlbumTitle').textContent = data.album_title || 'Unknown Album';
            document.getElementById('failedArtistName').textContent = data.artist_name || 'Unknown Artist';

            const coverEl = document.getElementById('failedAlbumCover');
            const safeFailedCover = sanitizeUrl(data.cover_url);
            if (safeFailedCover) {
                coverEl.src = safeFailedCover;
                coverEl.style.display = 'block';
            } else {
                coverEl.style.display = 'none';
            }

            const count = data.failed_tracks.length;
            document.getElementById('failedSubtitle').textContent =
                `${count} track${count > 1 ? 's' : ''} failed to download. Search YouTube or paste a link to retry.`;

            const list = document.getElementById('failedTracksList');
            list.innerHTML = data.failed_tracks.map((track, i) => `
                <div class="failed-track-item" id="failedTrack${i}">
                    <div class="failed-track-header">
                        <div class="failed-track-title">
                            <i class="fa-solid fa-music" style="color: var(--primary);"></i>
                            ${escapeHtml(track.title)}
                        </div>
                        <div class="failed-track-reason">${escapeHtml(track.reason)}</div>
                    </div>
                    <div class="failed-track-inputs" id="failedSearchRow${i}">
                        <input type="text" id="failedSearch${i}" placeholder="Search YouTube..."
                            value="${escapeHtml((data.artist_name || '') + ' ' + track.title)}"
                            onkeydown="if(event.key==='Enter')searchFailedTrack(${i})">
                        <button class="ft-btn" onclick="searchFailedTrack(${i})">
                            <i class="fa-solid fa-search"></i> Search
                        </button>
                    </div>
                    <div class="failed-track-separator">or paste a YouTube URL</div>
                    <div class="failed-track-inputs" id="failedUrlRow${i}">
                        <input type="text" id="failedUrl${i}" placeholder="https://youtube.com/watch?v=..."
                            onkeydown="if(event.key==='Enter')manualDownloadTrack(${i})">
                        <button class="ft-btn" onclick="manualDownloadTrack(${i})">
                            <i class="fa-solid fa-download"></i> Download
                        </button>
                    </div>
                    <div class="ft-search-results" id="searchResults${i}"></div>
                    <div class="ft-video-preview" id="videoPreview${i}" style="display:none;"></div>
                </div>
            `).join('');

            document.getElementById('failedOverlay').classList.add('active');

            /* Show reopen button & update count */
            const failedBtn = document.getElementById('failedTracksBtn');
            document.getElementById('failedTracksBtnText').textContent =
                count + ' Failed Track' + (count > 1 ? 's' : '');
            failedBtn.classList.add('active');
        }

        function closeFailedOverlay() {
            document.getElementById('failedOverlay').classList.remove('active');
            /* Close any open video previews */
            document.querySelectorAll('.ft-video-preview').forEach(el => {
                el.style.display = 'none';
                el.innerHTML = '';
            });
        }

        async function searchFailedTrack(index) {
            const query = document.getElementById(`failedSearch${index}`).value.trim();
            if (!query) return;

            const resultsDiv = document.getElementById(`searchResults${index}`);
            resultsDiv.classList.add('active');
            resultsDiv.innerHTML = '<div class="ft-loading"><i class="fa-solid fa-spinner fa-spin"></i> Searching YouTube...</div>';

            try {
                const res = await fetch('/api/youtube/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await res.json();

                if (data.results && data.results.length > 0) {
                    resultsDiv.innerHTML = data.results.map(r => {
                        const dur = r.duration ? `${Math.floor(r.duration / 60)}:${(r.duration % 60).toString().padStart(2, '0')}` : '';
                        const thumbHtml = r.thumbnail
                            ? `<img src="${r.thumbnail}" alt="">`
                            : `<div style="width:48px;height:36px;background:var(--surface);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><i class="fa-brands fa-youtube" style="color:var(--text-dim);"></i></div>`;
                        return `
                            <div class="ft-result-item" data-url="${escapeHtml(r.url)}">
                                ${thumbHtml}
                                <div class="ft-result-info">
                                    <div class="ft-result-title">${escapeHtml(r.title)}</div>
                                    <div class="ft-result-meta">${escapeHtml(r.channel)}${dur ? ' &bull; ' + dur : ''}</div>
                                </div>
                                <button class="ft-result-preview" onclick="event.stopPropagation();previewVideo(${index}, this.parentElement.dataset.url)" title="Preview">
                                    <i class="fa-solid fa-play"></i>
                                </button>
                                <button class="ft-result-select" onclick="selectSearchResult(${index}, this.parentElement)">Select</button>
                            </div>
                        `;
                    }).join('');
                } else {
                    resultsDiv.innerHTML = '<div class="ft-loading">No results found. Try a different search.</div>';
                }
            } catch (e) {
                resultsDiv.innerHTML = '<div class="ft-loading" style="color:#ef4444;">Search failed. Please try again.</div>';
            }
        }

        function selectSearchResult(index, el) {
            const url = el.dataset.url;
            document.getElementById(`failedUrl${index}`).value = url;
            document.getElementById(`searchResults${index}`).classList.remove('active');
            /* Close video preview if open */
            const preview = document.getElementById(`videoPreview${index}`);
            if (preview) { preview.style.display = 'none'; preview.innerHTML = ''; }
        }

        async function manualDownloadTrack(index) {
            const track = failedTracksData[index];
            if (!track) return;

            const url = document.getElementById(`failedUrl${index}`).value.trim();
            if (!url) {
                document.getElementById(`failedUrl${index}`).style.borderColor = '#ef4444';
                setTimeout(() => document.getElementById(`failedUrl${index}`).style.borderColor = '', 2000);
                return;
            }

            const item = document.getElementById(`failedTrack${index}`);
            const inputElements = item.querySelectorAll('.failed-track-inputs, .failed-track-separator, .ft-search-results, .ft-video-preview');
            inputElements.forEach(el => { el.style.display = 'none'; if (el.classList.contains('ft-video-preview')) el.innerHTML = ''; });

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'ft-loading';
            loadingDiv.id = `failedLoading${index}`;
            loadingDiv.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Downloading and tagging...';
            item.querySelector('.failed-track-header').after(loadingDiv);

            try {
                const res = await fetch('/api/download/manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        youtube_url: url,
                        track_title: track.title,
                        track_num: track.track_num,
                    })
                });
                const data = await res.json();

                loadingDiv.remove();

                if (data.success) {
                    item.classList.add('resolved');
                    item.querySelector('.failed-track-reason').textContent = '';
                    const successDiv = document.createElement('div');
                    successDiv.className = 'failed-track-success';
                    successDiv.innerHTML = '<i class="fa-solid fa-circle-check"></i> Downloaded successfully';
                    item.querySelector('.failed-track-header').appendChild(successDiv);
                    checkAllResolved();
                } else {
                    inputElements.forEach(el => el.style.display = '');
                    const errDiv = document.createElement('div');
                    errDiv.style.cssText = 'color: #ef4444; font-size: 0.85rem; margin: 0.5rem 0; padding-left: 1.5rem;';
                    errDiv.textContent = data.message || 'Download failed';
                    item.querySelector('.failed-track-header').after(errDiv);
                    setTimeout(() => errDiv.remove(), 6000);
                }
            } catch (e) {
                loadingDiv.remove();
                inputElements.forEach(el => el.style.display = '');
            }
        }

        function extractYouTubeId(url) {
            try {
                const u = new URL(url);
                if (u.hostname.includes('youtu.be')) return u.pathname.slice(1).split('/')[0];
                if (u.searchParams.has('v')) return u.searchParams.get('v');
                const m = u.pathname.match(/\/embed\/([^/?]+)/);
                if (m) return m[1];
            } catch (_) {}
            return null;
        }

        function previewVideo(index, url) {
            const container = document.getElementById(`videoPreview${index}`);
            if (!container) return;

            /* Toggle off if same video already shown */
            if (container.style.display !== 'none' && container.dataset.currentUrl === url) {
                container.style.display = 'none';
                container.innerHTML = '';
                container.dataset.currentUrl = '';
                return;
            }

            const videoId = extractYouTubeId(url);
            if (!videoId) {
                container.innerHTML = '<div style="color:#ef4444;padding:0.75rem;text-align:center;font-size:0.85rem;">Unable to load preview</div>';
                container.style.display = 'block';
                return;
            }

            container.dataset.currentUrl = url;
            container.innerHTML = `
                <button class="ft-preview-close" onclick="this.parentElement.style.display='none';this.parentElement.innerHTML='';" title="Close preview">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0"
                    allow="autoplay; encrypted-media" allowfullscreen></iframe>
            `;
            container.style.display = 'block';

            /* Scroll the preview into view */
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function reopenFailedOverlay() {
            document.getElementById('failedOverlay').classList.add('active');
        }

        function checkAllResolved() {
            const items = document.querySelectorAll('.failed-track-item');
            const resolved = document.querySelectorAll('.failed-track-item.resolved');
            if (items.length > 0 && items.length === resolved.length) {
                /* All tracks resolved  update button */
                const btn = document.getElementById('failedTracksBtn');
                btn.innerHTML = '<i class="fa-solid fa-circle-check"></i> <span>All Resolved!</span>';
                btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                btn.style.boxShadow = '0 8px 24px rgba(16, 185, 129, 0.35)';
                /* Auto-close overlay after a brief pause */
                setTimeout(() => {
                    document.getElementById('failedOverlay').classList.remove('active');
                }, 1500);
                /* Hide button after a few seconds */
                setTimeout(() => {
                    btn.classList.remove('active');
                    btn.style.background = '';
                    btn.style.boxShadow = '';
                }, 5000);
            } else {
                /* Update remaining count */
                const remaining = items.length - resolved.length;
                document.getElementById('failedTracksBtnText').textContent =
                    remaining + ' Failed Track' + (remaining > 1 ? 's' : '');
            }
        }

        async function checkForPathConflict() {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                if (config.path_conflict) {
                    document.getElementById('pathConflictBanner').style.display = 'flex';
                } else {
                    document.getElementById('pathConflictBanner').style.display = 'none';
                }
            } catch (e) {
                console.error("Error checking configuration:", e);
            }
        }

        checkForPathConflict();

    </script>
</body>

</html>
